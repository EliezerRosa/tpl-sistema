'use strict';

/* ================= CONFIG ================= */
const GITHUB_USER        = 'EliezerRosa';
const GITHUB_REPO        = 'tpl-sistema';
const ADMIN_USERNAME     = 'Zico';
const GITHUB_CLIENT_ID   = 'Ov23liEwjAzKygVLClRS';

const DAY_NAMES  = ['DOM','SEG','TER','QUA','QUI','SEX','SÁB'];
const MONTH_NAMES = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho',
                     'Agosto','Setembro','Outubro','Novembro','Dezembro'];
const TIME_SLOTS = [
  { label: '7:00',  hour: 7  },
  { label: '9:00',  hour: 9  },
  { label: '14:00', hour: 14 },
  { label: '16:00', hour: 16 },
  { label: '18:00', hour: 18 }
];
const DAYS_AHEAD = 32;
/* ========================================== */

class TPLSystem {
  constructor() {
    this.deviceId        = null;
    this.userName        = null;
    this.transactions    = new Map(); // id -> transação
    this.scheduleState   = new Map(); // slotId -> idTransação vigente
    this.syncInterval    = null;
    this.isPublishing    = false;
    this.adminPat        = null;

    this.dbUrl       = `https://${GITHUB_USER}.github.io/${GITHUB_REPO}/database.json`;
    this.dispatchUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/dispatches`;
  }

  /* ---------- Inicialização ---------- */
  async init() {
    this.initIdentity();
    this.restoreTransactions();
    this.renderInitialTable();
    this.setupUI();
    await this.startAutoSync();
    this.log('Sistema inicializado.');
  }

  initIdentity() {
    let id = localStorage.getItem('tpl_device_id');
    if (!id) {
      id = this.hash(Date.now() + ':' + Math.random());
      localStorage.setItem('tpl_device_id', id);
    }
    this.deviceId = id;
    this.userName = localStorage.getItem('tpl_user_name');
    const devEl = document.getElementById('deviceId');
    if (devEl) devEl.textContent = id.substring(0, 8);
  }

  /* ---------- Utilidades ---------- */
  hash(seed) {
    let h = 0;
    for (let i = 0; i < seed.length; i++) {
      h = (h << 5) - h + seed.charCodeAt(i);
      h |= 0;
    }
    return 'h' + Math.abs(h).toString(36) + (Date.now() % 1000).toString(36);
  }

  log(msg, level = 'log') {
    const panel = document.getElementById('logPanel');
    const t = new Date().toLocaleTimeString();
    const color =
      level === 'error' ? '#f44336' :
      level === 'warn'  ? '#ff9800' :
      '#4caf50';
    if (panel) {
      panel.innerHTML += `<span style="color:${color}">[${t}] ${msg}</span><br>`;
      panel.scrollTop = panel.scrollHeight;
      panel.style.opacity = 1;
      panel.style.pointerEvents = 'auto';
      setTimeout(() => {
        panel.style.opacity = 0;
        panel.style.pointerEvents = 'none';
      }, 5000);
    }
    // eslint-disable-next-line no-console
    console[level === 'error' ? 'error' : level === 'warn' ? 'warn' : 'log'](`[TPL] ${msg}`);
  }

  /* ---------- Persistência Local ---------- */
  restoreTransactions() {
    try {
      const saved = JSON.parse(localStorage.getItem('tpl_transactions') || '[]');
      saved.forEach(tx => this.transactions.set(tx.id, tx));
      this.rebuildSchedule();
    } catch {
      this.log('Falha ao carregar transações locais', 'warn');
    }
  }

  saveTransactions() {
    localStorage.setItem(
      'tpl_transactions',
      JSON.stringify(Array.from(this.transactions.values()))
    );
  }

  /* ---------- UI ---------- */
  setupUI() {
    const nameSetup = document.getElementById('nameSetup');
    const userNameEl = document.getElementById('userName');

    if (this.userName) {
      if (userNameEl) userNameEl.textContent = this.userName;
      if (nameSetup) nameSetup.style.display = 'none';
      if (this.userName === ADMIN_USERNAME) {
        this.log('👑 Modo Admin', 'info');
        this.showAdminPrompt();
      }
    } else if (nameSetup) {
      nameSetup.style.display = 'block';
    }

    this.updateHeaderMonth();
  }

  updateHeaderMonth() {
    const today = new Date();
    const el = document.getElementById('monthTitle');
    if (el) el.textContent = `Programação - ${MONTH_NAMES[today.getMonth()]} ${today.getFullYear()}`;
  }

  showAdminPrompt() {
    const host = document.getElementById('nameSetup');
    if (!host) return;
    host.style.display = 'block';
    host.innerHTML = `
      <p><strong>👑 CONFIGURAÇÃO ADMIN</strong></p>
      <input id="patInput" type="password" placeholder="Token PAT (repo)" style="width:300px;padding:10px;margin:10px auto;display:block">
      <button onclick="saveAdminToken()" style="padding:10px 20px;background:#4CAF50;color:#fff;border:none;border-radius:4px;cursor:pointer">
        Salvar Token
      </button>
      <p style="font-size:.8em;color:#666"><a href="https://github.com/settings/tokens" target="_blank">Criar Token</a></p>
    `;
  }

  /* ---------- Tabela / Slots ---------- */
  renderInitialTable() {
    const tbody = document.getElementById('scheduleBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    const today = new Date();
    const todayISO = today.toISOString().split('T')[0];
    const currentHour = today.getHours();

    for (let offset = 0; offset < DAYS_AHEAD; offset++) {
      const date = new Date(today);
      date.setDate(today.getDate() + offset);
      const isoDate = date.toISOString().split('T')[0];
      const pastDay = isoDate < todayISO;

      const row = document.createElement('tr');
      if (pastDay) row.classList.add('past-date');

      const dateStr = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
      const dayName = DAY_NAMES[date.getDay()];

      const cellsHtml = TIME_SLOTS.map(ts => {
        let inner = '';
        for (let i = 0; i < 3; i++) {
          const pastSlot = (isoDate === todayISO) && ts.hour < currentHour;
          const classes = ['slot'];
            if (pastSlot) classes.push('past-slot');
          inner += `<div class="${classes.join(' ')}" data-slot-id="${isoDate}-${ts.label}-${i}"></div>`;
        }
        return `<td>${inner}</td>`;
      }).join('');

      let obs = '';
      for (let i = 0; i < 3; i++) {
        obs += `<div class="slot" data-slot-id="${isoDate}-obs-${i}"></div>`;
      }

      row.innerHTML = `
        <td class="date-cell">${dateStr}</td>
        <td class="day-of-week">${dayName}</td>
        ${cellsHtml}
        <td>${obs}</td>
      `;
      tbody.appendChild(row);
    }

    tbody.querySelectorAll('.slot').forEach(div => {
      if (!div.closest('.past-date') && !div.classList.contains('past-slot')) {
        div.addEventListener('click', () => handleSlotClick(div));
      }
    });
  }

  refreshSlots() {
    document.querySelectorAll('.slot[data-slot-id]').forEach(div => {
      const slotId = div.dataset.slotId;
      const txId = this.scheduleState.get(slotId);
      const tx = txId ? this.transactions.get(txId) : null;

      div.className = 'slot'; // reset
      div.textContent = '';

      if (div.classList.contains('past-slot')) {
        div.className = 'slot past-slot';
        return;
      }

      if (tx && tx.data) {
        div.textContent = tx.data.name;
        div.classList.add(tx.ownerId === this.deviceId ? 'my-slot' : 'taken');
        div.title = (tx.ownerId === this.deviceId)
          ? 'Seu agendamento.'
          : `Agendado por ${tx.data.name}`;
      } else {
        div.classList.add('available');
      }
    });

    if (this.userName === ADMIN_USERNAME) {
      this.enableAdminDrag();
    }
  }

  enableAdminDrag() {
    document.querySelectorAll('.slot').forEach(el => {
      const mineOrTaken = el.classList.contains('my-slot') || el.classList.contains('taken');
      const available = el.classList.contains('available');
      if (mineOrTaken) {
        el.draggable = true;
        el.addEventListener('dragstart', this.onDragStart);
      }
      if (available) {
        el.addEventListener('dragover', this.onDragOver);
        el.addEventListener('dragleave', this.onDragLeave);
        el.addEventListener('drop', this.onDrop);
      }
    });
  }

  /* ---------- Drag & Drop (admin) ---------- */
  onDragStart = (e) => {
    e.dataTransfer.setData('text/plain', e.target.dataset.slotId);
    e.target.classList.add('dragging');
  };

  onDragOver = (e) => {
    e.preventDefault();
    e.target.classList.add('drop-target');
  };

  onDragLeave = (e) => {
    e.target.classList.remove('drop-target');
  };

  onDrop = async (e) => {
    e.preventDefault();
    e.target.classList.remove('drop-target');
    document.querySelector('.dragging')?.classList.remove('dragging');

    const from = e.dataTransfer.getData('text/plain');
    const targetSlot = e.target.closest('.slot');
    if (!targetSlot) return;
    const to = targetSlot.dataset.slotId;

    if (!from || !to || from === to || !targetSlot.classList.contains('available')) return;

    this.log(`👑 MOVE: ${from} -> ${to}`, 'info');
    const currentTxId = this.scheduleState.get(from);
    const currentTx = currentTxId ? this.transactions.get(currentTxId) : null;
    if (currentTx && currentTx.data) {
      await this.createTransaction(from, 'delete');
      await this.createTransaction(to, 'set', currentTx.data);
    }
  };

  /* ---------- Operações de Slot ---------- */
  async toggleSlot(slotId) {
    const currentTxId = this.scheduleState.get(slotId);
    const currentTx   = currentTxId ? this.transactions.get(currentTxId) : null;

    if (currentTx && currentTx.ownerId === this.deviceId) {
      await this.createTransaction(slotId, 'delete');
    } else if (!currentTx) {
      await this.createTransaction(slotId, 'set');
    }
  }

  async createTransaction(slotId, action, clonedData = null) {
    const data = clonedData || (action === 'set'
      ? { name: this.userName, deviceId: this.deviceId }
      : null);

    const tx = {
      id:        this.hash(slotId + action + Date.now()),
      timestamp: Date.now(),
      slotId,
      action,
      ownerId:   this.deviceId,
      data
    };

    this.transactions.set(tx.id, tx);
    this.rebuildSchedule();
    this.saveTransactions();
    this.refreshSlots();
    await this.sendSignal('nova-transacao', { transaction: JSON.stringify(tx) });
  }

  rebuildSchedule() {
    this.scheduleState.clear();
    const ordered = Array.from(this.transactions.values())
      .sort((a, b) => a.timestamp - b.timestamp);
    const map = new Map();

    for (const tx of ordered) {
      if (tx.action === 'set') {
        if (!map.has(tx.slotId)) map.set(tx.slotId, tx.id);
      } else if (tx.action === 'delete') {
        const setId = map.get(tx.slotId);
        if (setId) {
          const ref = this.transactions.get(setId);
          if (ref && ref.ownerId === tx.ownerId) {
            map.delete(tx.slotId);
          }
        }
      }
    }
    this.scheduleState = map;
  }

  /* ---------- GitHub Dispatch ---------- */
  async sendSignal(eventType, payload, token = null) {
    if (this.isPublishing) {
      this.log('Aguarde publicação anterior.', 'warn');
      return;
    }
    this.isPublishing = true;
    try {
      const headers = {
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      };
      if (token) headers.Authorization = `token ${token}`;
      const resp = await fetch(this.dispatchUrl, {
        method: 'POST',
        headers,
        body: JSON.stringify({ event_type: eventType, client_payload: payload })
      });
      if (resp.status !== 204) throw new Error('Status ' + resp.status);
      this.log(`Sinal '${eventType}' enviado.`);
    } catch (err) {
      this.log(`Erro ao enviar sinal: ${err.message}`, 'error');
    } finally {
      this.isPublishing = false;
    }
  }

  /* ---------- Sincronização "fake" (GitHub Pages) ---------- */
  async fetchLatestData() {
    this.updateSyncStatus('Sincronizando...');
    try {
      const resp = await fetch(`${this.dbUrl}?v=${Date.now()}`);
      if (!resp.ok) throw new Error('Status ' + resp.status);
      const json = await resp.json();
      let added = 0;
      if (Array.isArray(json?.transactions)) {
        json.transactions.forEach(t => {
          if (t && t.id && !this.transactions.has(t.id)) {
            this.transactions.set(t.id, t);
            added++;
          }
        });
      }
      if (added) {
        this.log(`${added} novas transações.`);
        this.rebuildSchedule();
        this.saveTransactions();
        this.refreshSlots();
      }
      this.updateSyncStatus(`Sincronizado às ${new Date().toLocaleTimeString()}`);
    } catch (err) {
      this.log(`ERRO DE SINCRONIZAÇÃO: ${err.message}`, 'error');
      this.updateSyncStatus('Erro. Próxima tentativa em 30s.');
    }
  }

  async startAutoSync() {
    await this.fetchLatestData();
    this.syncInterval = setInterval(() => this.fetchLatestData(), 30000);
  }

  updateSyncStatus(msg) {
    const el = document.getElementById('syncStatus');
    if (el) el.textContent = `⚡ ${msg}`;
  }

  /* ---------- Admin Token ---------- */
  async saveAdminToken(token) {
    try {
      this.log('Salvando token admin...', 'info');
      await this.sendSignal('configurar-admin-token', { adminToken: token }, token);
    } catch (err) {
      this.log(`Erro token: ${err.message}`, 'error');
    }
  }
}

/* =========== Funções de Interface (globais) =========== */
let tplSystem = null;

function setupUser() {
  const input = document.getElementById('nameInput');
  if (!input) return;
  const name = input.value.trim();
  if (!name) {
    alert('Informe seu nome.');
    return;
  }
  tplSystem.userName = name;
  localStorage.setItem('tpl_user_name', name);
  tplSystem.setupUI();
  tplSystem.refreshSlots();
  tplSystem.log('Nome salvo!');
  if (name === ADMIN_USERNAME) redirectToGitHubAuth();
}

function redirectToGitHubAuth() {
  const url = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CLIENT_ID}&scope=repo,workflow`;
  window.location.href = url;
}

async function saveAdminToken() {
  const input = document.getElementById('patInput');
  if (!input) return;
  const token = input.value.trim();
  if (!token) { alert('Cole o Token PAT.'); return; }
  await tplSystem.saveAdminToken(token);
}

function handleSlotClick(el) {
  if (!tplSystem.userName) {
    alert('Configure seu nome antes.');
    document.getElementById('nameSetup').style.display = 'block';
    return;
  }
  tplSystem.toggleSlot(el.dataset.slotId);
}

/* =========== Bootstrap DOM =========== */
document.addEventListener('DOMContentLoaded', async () => {
  tplSystem = new TPLSystem();
  await tplSystem.init();
  tplSystem.refreshSlots();
});

/* Expor globais necessárias ao HTML inline */
window.setupUser = setupUser;
window.saveAdminToken = saveAdminToken;