<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPL - Sistema Automatizado</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f5f5f5; }
        h1, h2 { text-align: center; margin-bottom: 5px; }
        h1 { color: white; background-color: #c00000; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        h2 { color: white; background-color: #ff8c00; padding: 8px; font-size: 1.1em; margin-bottom: 20px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        #sync-controls { display: flex; justify-content: center; align-items: center; gap: 20px; padding: 15px; background-color: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; margin-bottom: 20px; }
        #syncStatus { font-weight: bold; color: #1565c0; }
        #user-status { text-align: center; margin-bottom: 15px; font-size: 0.9em; background: white; padding: 15px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .user-id { color: #666; font-family: monospace; font-size: 0.8em; }
        .user-name { color: #2c5aa0; font-weight: bold; font-size: 1.2em; margin: 5px 0; }
        .name-setup, .admin-setup { background: #e3f2fd; border: 2px dashed #2196f3; padding: 20px; margin: 15px 0; border-radius: 8px; text-align: center; }
        .admin-setup { background: #fff3e0; border-color: #ff9800; }
        .name-setup input, .admin-setup input { padding: 10px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em; margin: 10px; width: 300px; }
        .name-setup button, .admin-setup button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        .name-setup button:hover, .admin-setup button:hover { background-color: #45a049; }
        table { width: 100%; border-collapse: collapse; border: 2px solid black; box-shadow: 0 4px 8px rgba(0,0,0,0.1); background: white; border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid #a0a0a0; padding: 8px; text-align: left; vertical-align: top; }
        thead th { background-color: #fff2cc; font-weight: bold; text-align: center; border-bottom: 2px solid black; position: sticky; top: 0; z-index: 10; }
        .header-dia { width: 100px; }
        .header-dayofweek { width: 25px; }
        .header-time { width: 120px; }
        .header-obs { width: 150px; }
        tbody td { background-color: #ffffcc; }
        .date-cell, .day-of-week { background-color: #f2f2f2; font-weight: bold; text-align: center; vertical-align: middle; }
        .day-of-week { writing-mode: vertical-rl; transform: rotate(180deg); padding: 8px 2px; width: 25px; }
        .slot { display: block; min-height: 20px; border-bottom: 1px solid #ccc; margin-bottom: 2px; font-size: 0.9em; padding: 4px; cursor: pointer; border-radius: 4px; transition: all 0.3s ease; position: relative; }
        .slot.available { background-color: #e8f5e8; border: 1px dashed #4caf50; }
        .slot.available:hover { background-color: #c8e6c9; border-style: solid; transform: scale(1.02); }
        .slot.my-slot { background-color: #fff3e0; border: 1px solid #ff9800; color: #e65100; font-weight: 500; }
        .slot.my-slot:hover { background-color: #ffe0b2; box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3); }
        .slot.taken { background-color: #e3f2fd; border: 1px solid #2196f3; color: #1565c0; cursor: not-allowed; }
        .past-date { opacity: 0.6; background-color: #eeeeee; }
        .past-date .slot, .past-slot { cursor: not-allowed !important; background-color: #eeeeee !important; color: #b0b0b0 !important; border-style: solid !important; border-color: #ddd !important; text-decoration: line-through; }
        .log-panel { position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: #0f0; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 10px; max-width: 350px; max-height: 150px; overflow-y: auto; z-index: 1000; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
        .slot[draggable="true"] { cursor: grab !important; }
        .slot.dragging { opacity: 0.4; border: 2px dashed #c00000; }
        .slot.drop-target { background-color: #b3e5fc !important; border: 2px solid #01579b !important; }
    </style>
</head>
<body>
    <h1>TPL - Sistema Automatizado</h1>
    <h2 id="monthTitle">Programa√ß√£o Semanal Permanente</h2>
    <div id="sync-controls">
        <div id="syncStatus">‚ö° Conectando...</div>
    </div>
    <div id="user-status">
        <div class="user-name" id="userName">Configurar Nome</div>
        <div class="user-id">ID: <span id="deviceId"></span></div>
    </div>
    
    <!-- Setup de nome para usu√°rios normais -->
    <div id="nameSetup" class="name-setup" style="display:none;">
        <p><strong>Para participar, configure seu nome:</strong></p>
        <input type="text" id="nameInput" placeholder="Digite seu nome" maxlength="30">
        <button onclick="setupUser()">Salvar Nome</button>
    </div>

    <!-- Setup do token para admin -->
    <div id="adminSetup" class="admin-setup" style="display:none;">
        <p><strong>üëë CONFIGURA√á√ÉO ADMIN</strong></p>
        <p>Para ativar recursos admin, configure seu token GitHub:</p>
        <input id="patInput" type="password" placeholder="Cole seu Personal Access Token aqui">
        <button onclick="saveAdminToken()">Ativar Modo Admin</button>
        <p style="font-size:0.8em;color:#666;">
            <a href="https://github.com/settings/tokens" target="_blank">Criar Token</a> | 
            Permiss√µes necess√°rias: repo, workflow
        </p>
    </div>

    <table id="scheduleTable">
        <thead>
            <tr>
                <th class="header-dia">DIA</th>
                <th class="header-dayofweek"></th>
                <th class="header-time">Manh√£<br>7:00</th>
                <th class="header-time">Manh√£<br>9:00</th>
                <th class="header-time">Tarde<br>14:00</th>
                <th class="header-time">Tardinha<br>16:00</th>
                <th class="header-time">Noite<br>18:00</th>
                <th class="header-obs">Observa√ß√µes</th>
            </tr>
        </thead>
        <tbody id="scheduleBody"></tbody>
    </table>
    <div class="log-panel" id="logPanel"></div>

    <script>
/* ================= CONFIG ================= */
const GITHUB_USER = 'EliezerRosa';
const GITHUB_REPO = 'tpl-sistema';
const ADMIN_USERNAME = 'EliezerRosa'; // Mudando para corresponder ao seu nome real
const ADMIN_DEVICE_IDS = ['hun16mw7']; // Adicione seu device ID aqui se necess√°rio

const DAY_NAMES = ['DOM','SEG','TER','QUA','QUI','SEX','S√ÅB'];
const MONTH_NAMES = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho',
                     'Agosto','Setembro','Outubro','Novembro','Dezembro'];
const TIME_SLOTS = [
  { label: '7:00',  hour: 7  },
  { label: '9:00',  hour: 9  },
  { label: '14:00', hour: 14 },
  { label: '16:00', hour: 16 },
  { label: '18:00', hour: 18 }
];
const DAYS_AHEAD = 32;

/* ========================================== */

class TPLSystem {
  constructor() {
    this.deviceId = null;
    this.userName = null;
    this.adminToken = null;
    this.transactions = new Map();
    this.scheduleState = new Map();
    this.syncInterval = null;
    this.isPublishing = false;
    
    this.dbUrl = `https://${GITHUB_USER}.github.io/${GITHUB_REPO}/database.json`;
    this.dispatchUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/dispatches`;
  }

  /* ---------- Inicializa√ß√£o ---------- */
  async init() {
    this.initIdentity();
    this.loadAdminToken();
    this.restoreTransactions();
    this.renderInitialTable();
    this.setupUI();
    await this.startAutoSync();
    this.log('Sistema inicializado.');
  }

  initIdentity() {
    let id = localStorage.getItem('tpl_device_id');
    if (!id) {
      id = this.hash(Date.now() + ':' + Math.random());
      localStorage.setItem('tpl_device_id', id);
    }
    this.deviceId = id;
    this.userName = localStorage.getItem('tpl_user_name');
    const devEl = document.getElementById('deviceId');
    if (devEl) devEl.textContent = id.substring(0, 8);
  }

  loadAdminToken() {
    this.adminToken = localStorage.getItem('tpl_admin_token');
  }

  /* ---------- Utilidades ---------- */
  hash(seed) {
    let h = 0;
    for (let i = 0; i < seed.length; i++) {
      h = (h << 5) - h + seed.charCodeAt(i);
      h |= 0;
    }
    return 'h' + Math.abs(h).toString(36) + (Date.now() % 1000).toString(36);
  }

  log(msg, level = 'log') {
    const panel = document.getElementById('logPanel');
    const t = new Date().toLocaleTimeString();
    const color =
      level === 'error' ? '#f44336' :
      level === 'warn' ? '#ff9800' :
      '#4caf50';
    if (panel) {
      panel.innerHTML += `<span style="color:${color}">[${t}] ${msg}</span><br>`;
      panel.scrollTop = panel.scrollHeight;
      panel.style.opacity = 1;
      panel.style.pointerEvents = 'auto';
      setTimeout(() => {
        panel.style.opacity = 0;
        panel.style.pointerEvents = 'none';
      }, 5000);
    }
    console[level === 'error' ? 'error' : level === 'warn' ? 'warn' : 'log'](`[TPL] ${msg}`);
  }

  isAdmin() {
    return this.userName === ADMIN_USERNAME || 
           ADMIN_DEVICE_IDS.includes(this.deviceId.substring(0, 8));
  }

  /* ---------- Persist√™ncia Local ---------- */
  restoreTransactions() {
    try {
      const saved = JSON.parse(localStorage.getItem('tpl_transactions') || '[]');
      saved.forEach(tx => this.transactions.set(tx.id, tx));
      this.rebuildSchedule();
    } catch {
      this.log('Falha ao carregar transa√ß√µes locais', 'warn');
    }
  }

  saveTransactions() {
    localStorage.setItem(
      'tpl_transactions',
      JSON.stringify(Array.from(this.transactions.values()))
    );
  }

  /* ---------- UI ---------- */
  setupUI() {
    const nameSetup = document.getElementById('nameSetup');
    const adminSetup = document.getElementById('adminSetup');
    const userNameEl = document.getElementById('userName');

    // Esconde todos os setups inicialmente
    if (nameSetup) nameSetup.style.display = 'none';
    if (adminSetup) adminSetup.style.display = 'none';

    if (this.userName) {
      // Usu√°rio j√° configurado
      if (userNameEl) userNameEl.textContent = this.userName;
      
      // Verifica se √© admin
      if (this.isAdmin()) {
        this.log('üëë Modo Admin Detectado', 'info');
        if (!this.adminToken && adminSetup) {
          // Admin sem token configurado
          adminSetup.style.display = 'block';
        } else if (this.adminToken) {
          this.log('‚úÖ Token Admin Carregado', 'info');
        }
      }
    } else {
      // Novo usu√°rio
      if (nameSetup) nameSetup.style.display = 'block';
    }

    this.updateHeaderMonth();
  }

  updateHeaderMonth() {
    const today = new Date();
    const el = document.getElementById('monthTitle');
    if (el) el.textContent = `Programa√ß√£o - ${MONTH_NAMES[today.getMonth()]} ${today.getFullYear()}`;
  }

  /* ---------- Tabela / Slots ---------- */
  renderInitialTable() {
    const tbody = document.getElementById('scheduleBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    const today = new Date();
    const todayISO = today.toISOString().split('T')[0];
    const currentHour = today.getHours();

    for (let offset = 0; offset < DAYS_AHEAD; offset++) {
      const date = new Date(today);
      date.setDate(today.getDate() + offset);
      const isoDate = date.toISOString().split('T')[0];
      const pastDay = isoDate < todayISO;

      const row = document.createElement('tr');
      if (pastDay) row.classList.add('past-date');

      const dateStr = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
      const dayName = DAY_NAMES[date.getDay()];

      const cellsHtml = TIME_SLOTS.map(ts => {
        let inner = '';
        for (let i = 0; i < 3; i++) {
          const pastSlot = (isoDate === todayISO) && ts.hour < currentHour;
          const classes = ['slot'];
          if (pastSlot) classes.push('past-slot');
          inner += `<div class="${classes.join(' ')}" data-slot-id="${isoDate}-${ts.label}-${i}"></div>`;
        }
        return `<td>${inner}</td>`;
      }).join('');

      let obs = '';
      for (let i = 0; i < 3; i++) {
        obs += `<div class="slot" data-slot-id="${isoDate}-obs-${i}"></div>`;
      }

      row.innerHTML = `
        <td class="date-cell">${dateStr}</td>
        <td class="day-of-week">${dayName}</td>
        ${cellsHtml}
        <td>${obs}</td>
      `;
      tbody.appendChild(row);
    }

    tbody.querySelectorAll('.slot').forEach(div => {
      if (!div.closest('.past-date') && !div.classList.contains('past-slot')) {
        div.addEventListener('click', () => this.handleSlotClick(div));
      }
    });
  }

  refreshSlots() {
    document.querySelectorAll('.slot[data-slot-id]').forEach(div => {
      const slotId = div.dataset.slotId;
      const txId = this.scheduleState.get(slotId);
      const tx = txId ? this.transactions.get(txId) : null;

      div.className = 'slot';
      div.textContent = '';

      if (div.classList.contains('past-slot')) {
        div.className = 'slot past-slot';
        return;
      }

      if (tx && tx.data) {
        div.textContent = tx.data.name;
        div.classList.add(tx.ownerId === this.deviceId ? 'my-slot' : 'taken');
        div.title = (tx.ownerId === this.deviceId)
          ? 'Seu agendamento.'
          : `Agendado por ${tx.data.name}`;
      } else {
        div.classList.add('available');
      }
    });

    if (this.isAdmin() && this.adminToken) {
      this.enableAdminDrag();
    }
  }

  enableAdminDrag() {
    document.querySelectorAll('.slot').forEach(el => {
      const mineOrTaken = el.classList.contains('my-slot') || el.classList.contains('taken');
      const available = el.classList.contains('available');
      if (mineOrTaken) {
        el.draggable = true;
        el.addEventListener('dragstart', this.onDragStart);
      }
      if (available) {
        el.addEventListener('dragover', this.onDragOver);
        el.addEventListener('dragleave', this.onDragLeave);
        el.addEventListener('drop', this.onDrop);
      }
    });
  }

  /* ---------- Drag & Drop (admin) ---------- */
  onDragStart = (e) => {
    e.dataTransfer.setData('text/plain', e.target.dataset.slotId);
    e.target.classList.add('dragging');
  };

  onDragOver = (e) => {
    e.preventDefault();
    e.target.classList.add('drop-target');
  };

  onDragLeave = (e) => {
    e.target.classList.remove('drop-target');
  };

  onDrop = async (e) => {
    e.preventDefault();
    e.target.classList.remove('drop-target');
    document.querySelector('.dragging')?.classList.remove('dragging');

    const from = e.dataTransfer.getData('text/plain');
    const targetSlot = e.target.closest('.slot');
    if (!targetSlot) return;
    const to = targetSlot.dataset.slotId;

    if (!from || !to || from === to || !targetSlot.classList.contains('available')) return;

    this.log(`üëë MOVE: ${from} -> ${to}`, 'info');
    const currentTxId = this.scheduleState.get(from);
    const currentTx = currentTxId ? this.transactions.get(currentTxId) : null;
    if (currentTx && currentTx.data) {
      await this.createTransaction(from, 'delete');
      await this.createTransaction(to, 'set', currentTx.data);
    }
  };

  /* ---------- Opera√ß√µes de Slot ---------- */
  handleSlotClick(el) {
    if (!this.userName) {
      alert('Configure seu nome antes.');
      document.getElementById('nameSetup').style.display = 'block';
      return;
    }
    this.toggleSlot(el.dataset.slotId);
  }

  async toggleSlot(slotId) {
    const currentTxId = this.scheduleState.get(slotId);
    const currentTx = currentTxId ? this.transactions.get(currentTxId) : null;

    if (currentTx && currentTx.ownerId === this.deviceId) {
      await this.createTransaction(slotId, 'delete');
    } else if (!currentTx) {
      await this.createTransaction(slotId, 'set');
    }
  }

  async createTransaction(slotId, action, clonedData = null) {
    const data = clonedData || (action === 'set'
      ? { name: this.userName, deviceId: this.deviceId }
      : null);

    const tx = {
      id: this.hash(slotId + action + Date.now()),
      timestamp: Date.now(),
      slotId,
      action,
      ownerId: this.deviceId,
      data
    };

    this.transactions.set(tx.id, tx);
    this.rebuildSchedule();
    this.saveTransactions();
    this.refreshSlots();
    
    // Usa o token admin se dispon√≠vel
    const token = this.adminToken || null;
    await this.sendSignal('nova-transacao', { transaction: JSON.stringify(tx) }, token);
  }

  rebuildSchedule() {
    this.scheduleState.clear();
    const ordered = Array.from(this.transactions.values())
      .sort((a, b) => a.timestamp - b.timestamp);
    const map = new Map();

    for (const tx of ordered) {
      if (tx.action === 'set') {
        if (!map.has(tx.slotId)) map.set(tx.slotId, tx.id);
      } else if (tx.action === 'delete') {
        const setId = map.get(tx.slotId);
        if (setId) {
          const ref = this.transactions.get(setId);
          if (ref && ref.ownerId === tx.ownerId) {
            map.delete(tx.slotId);
          }
        }
      }
    }
    this.scheduleState = map;
  }

  /* ---------- GitHub Dispatch ---------- */
  async sendSignal(eventType, payload, token = null) {
    if (this.isPublishing) {
      this.log('Aguarde publica√ß√£o anterior.', 'warn');
      return;
    }
    
    // Se n√£o tem token, n√£o tenta enviar
    if (!token && !this.adminToken) {
      this.log('‚ö†Ô∏è Sem token configurado. As mudan√ßas s√£o apenas locais.', 'warn');
      return;
    }

    this.isPublishing = true;
    try {
      const useToken = token || this.adminToken;
      const headers = {
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json',
        'Authorization': `token ${useToken}`
      };
      
      const resp = await fetch(this.dispatchUrl, {
        method: 'POST',
        headers,
        body: JSON.stringify({ event_type: eventType, client_payload: payload })
      });
      
      if (resp.status !== 204) {
        const errorText = await resp.text();
        throw new Error(`Status ${resp.status}: ${errorText}`);
      }
      
      this.log(`‚úÖ Sinal '${eventType}' enviado ao GitHub.`);
    } catch (err) {
      this.log(`‚ùå Erro ao enviar: ${err.message}`, 'error');
    } finally {
      this.isPublishing = false;
    }
  }

  /* ---------- Sincroniza√ß√£o ---------- */
  async fetchLatestData() {
    this.updateSyncStatus('Sincronizando...');
    try {
      const resp = await fetch(`${this.dbUrl}?v=${Date.now()}`);
      if (!resp.ok) throw new Error('Status ' + resp.status);
      const json = await resp.json();
      let added = 0;
      
      // Tratamento para array ou objeto com transactions
      let transactions = [];
      if (Array.isArray(json)) {
        transactions = json;
      } else if (json?.transactions && Array.isArray(json.transactions)) {
        transactions = json.transactions;
      }
      
      transactions.forEach(t => {
        if (t && t.id && !this.transactions.has(t.id)) {
          // Parse se for string
          const tx = typeof t === 'string' ? JSON.parse(t) : t;
          this.transactions.set(tx.id, tx);
          added++;
        }
      });
      
      if (added) {
        this.log(`üì• ${added} novas transa√ß√µes recebidas.`);
        this.rebuildSchedule();
        this.saveTransactions();
        this.refreshSlots();
      }
      this.updateSyncStatus(`Sincronizado √†s ${new Date().toLocaleTimeString()}`);
    } catch (err) {
      this.log(`Erro de sincroniza√ß√£o: ${err.message}`, 'error');
      this.updateSyncStatus('Erro. Pr√≥xima tentativa em 30s.');
    }
  }

  async startAutoSync() {
    await this.fetchLatestData();
    this.syncInterval = setInterval(() => this.fetchLatestData(), 30000);
  }

  updateSyncStatus(msg) {
    const el = document.getElementById('syncStatus');
    if (el) el.textContent = `‚ö° ${msg}`;
  }
}

/* =========== Fun√ß√µes Globais =========== */
let tplSystem = null;

function setupUser() {
  const input = document.getElementById('nameInput');
  if (!input) return;
  const name = input.value.trim();
  if (!name) {
    alert('Informe seu nome.');
    return;
  }
  tplSystem.userName = name;
  localStorage.setItem('tpl_user_name', name);
  tplSystem.setupUI();
  tplSystem.refreshSlots();
  tplSystem.log('‚úÖ Nome configurado!');
}

async function saveAdminToken() {
  const input = document.getElementById('patInput');
  if (!input) return;
  const token = input.value.trim();
  if (!token) {
    alert('Cole o Personal Access Token do GitHub.');
    return;
  }
  
  // Salva localmente
  localStorage.setItem('tpl_admin_token', token);
  tplSystem.adminToken = token;
  
  // Tenta enviar para o GitHub
  tplSystem.log('üîê Salvando token admin...', 'info');
  await tplSystem.sendSignal('configurar-admin-token', { adminToken: token }, token);
  
  // Esconde o setup
  const adminSetup = document.getElementById('adminSetup');
  if (adminSetup) adminSetup.style.display = 'none';
  
  tplSystem.log('‚úÖ Token Admin configurado!', 'info');
  tplSystem.refreshSlots();
}

/* =========== Inicializa√ß√£o =========== */
document.addEventListener('DOMContentLoaded', async () => {
  tplSystem = new TPLSystem();
  await tplSystem.init();
  tplSystem.refreshSlots();
});

// Expor fun√ß√µes globais
window.setupUser = setupUser;
window.saveAdminToken = saveAdminToken;
window.tplSystem = tplSystem; // Para debug
    </script>
</body>
</html>